name: Maven Release & Push Image

on:
  workflow_call: 
    inputs:
      java-version:
        required: false
        default: '17'
        type: string
      runner-label:
        required: true
        type: string
jobs:
  mvn-release:
    runs-on: ${{inputs.runner-label}}
    outputs:
      artifact_url: ${{ steps.get-release-artifact-url.outputs.artifact_url }}
    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Git credentials
          run: |
            git config --global user.name ${{ github.actor }}
            git config --global user.email "github-actions@beeldengeluid.nl"
            git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}".insteadOf "git@github.com:${{ github.repository }}.git"

        - name: Sync Local Tags with Remote Tags
          run: |
            git tag -l | xargs git tag -d
            git fetch --tags

        - name: Set up JDK 
          uses: actions/setup-java@v4.2.0
          with:
            distribution: 'temurin'  # You can change this to 'zulu' or another distribution if needed
            java-version: ${{ inputs.java-version || '17' }}
  
        - name: Check Java and Maven versions
          run: |
            java -version
            mvn -v
  
        - name: Cache Maven packages
          uses: actions/cache@v4.1.2
          with:
            path: ~/.m2/repository
            key: "${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}"
  
        - name: Prepare Maven settings.xml
          run: |
            mkdir -p ~/.m2
            sed -e "s|\${NEXUS_USERNAME}|${{ secrets.NEXUS_USERNAME }}|g" \
                -e "s|\${NEXUS_PASSWORD}|${{ secrets.NEXUS_PASSWORD }}|g" \
                /maven_settings.xml > ~/.m2/settings.xml

        - name: Maven Release Prepare
          run: |
            mvn release:prepare --batch-mode
            if [ $? -ne 0 ]; then
              echo "Maven Release Perform failed."
              exit 1
            fi

        - name: Maven Release Perform and Upload artifacts to nexus
          id: get-release-artifact-url
          run: |
            mvn release:perform --batch-mode | tee maven_release_output.log
            if [ $? -ne 0 ]; then
              echo "Maven Release Perform failed."
              exit 1
            fi
            artifact_url=$(grep -oP '(?<=Uploaded to beng-nexus: ).*museum-rest.*?\.war' maven_release_output.log)
            echo "artifact_url=$artifact_url" >> $GITHUB_OUTPUT

        - name: Post Clear of git URL Replacements
          if: always()
          run: |
            for entry in $(git config --global --get-regexp 'url.*.insteadOf' | awk '{print $1}'); do
              echo "removing $entry"
              git config --global --unset-all "$entry"
            done

  build-and-push-image:
    needs: mvn-release
    uses: beeldengeluid/gha-workflows/.github/workflows/publish-image.yml@mvn-project-workflows
    secrets: inherit
    with:
        artifact-url: ${{ needs.maven-release.outputs.artifact_url }} 
        runner-label: ${{ inputs.runner-label }}  

